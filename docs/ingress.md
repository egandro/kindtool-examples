# Ingress

Ingress in k8s is (one way) how you access http/https from outside of your cluster.

e.g. http/s://<ip-of-you-host>:<exposed port>


## kindfile.yaml

```
# enable ingress
ingress=true
# enable http port
ingress_http_port=8000
# enable https port (you might not use it)
ingress_https_port=8443
```

## Deployment files

Ingress

```
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: example-ingress
spec:
  rules:
  - http: # we use http
      paths:
      - pathType: Prefix
        path: "/foo" # prefix
        backend:
          service:
            name: foo-service # your service
            port:
              number: 5678
```

## Pitfalls

If you use multiple worker nodes, e.g. kindfile.yaml has this entry

```
worker_nodes=3
```

then k8s decides on what worker your pods are. That is really nice and that is why you want this in real live k8s clusters. However `kind` uses docker-in-docker. Worker nodes are just docker containers.

see:

```
$ cat config.yaml
# generated by kindtool: 0.0.3
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
- role: worker
- role: worker
$ kind create cluster --config=config.yaml
$ docker ps
CONTAINER ID   IMAGE                  COMMAND                  CREATED              STATUS              PORTS                       NAMES
521a0da9a30f   kindest/node:v1.25.3   "/usr/local/bin/entr…"   About a minute ago   Up About a minute                               kind-worker3
0e0f185ef525   kindest/node:v1.25.3   "/usr/local/bin/entr…"   About a minute ago   Up About a minute                               kind-worker2
27901aa9ba4f   kindest/node:v1.25.3   "/usr/local/bin/entr…"   About a minute ago   Up About a minute   127.0.0.1:35939->6443/tcp   kind-control-plane
be6b36421d74   kindest/node:v1.25.3   "/usr/local/bin/entr…"   About a minute ago   Up About a minute                               kind-worker
```

`kindtool` automaticually detects the `worker_nodes>0` configuration and will expose the HTTP/HTTPS incress port on the first worker node (or on the control-plane - if you have a setup without workers).

The pods (or services) that expose the ports, need to select the k8s node.

```
specs:
  #[...]
  nodeSelector:
    "ingress-ready": "true" # automaticually labeled for worker nodes by kindtool
```

from $(kindfile_yaml_dir)/.kind/config/config.yaml
```
...
- role: worker
# read about labels: https://kind.sigs.k8s.io/docs/user/configuration/
  labels:
    "worker": "true"
    "worker1": "true"
# ingress
    "tier": "frontend"
    "ingress-ready": "true" # used to pick this worker as public endpoint port node
  # the first worker node gets the public port for ingress
  # this needs to be moved to the control-plane, if you don' have workers
  extraPortMappings:
  # ingress
  - containerPort: 80
    hostPort: 8000
  - containerPort: 443
    hostPort: 8443
...
```

exposed ports in docker


```
$ docker ps
CONTAINER ID   IMAGE                  COMMAND                  CREATED              STATUS              PORTS                                         NAMES
1744639dcdf7   kindest/node:v1.25.3   "/usr/local/bin/entr…"   About a minute ago   Up About a minute   192.168.18.128:46701->6443/tcp                kind-control-plane
1bd1be2e167e   kindest/node:v1.25.3   "/usr/local/bin/entr…"   About a minute ago   Up About a minute   0.0.0.0:8000->80/tcp, 0.0.0.0:8443->443/tcp   kind-worker
ba8e314d7b8a   kindest/node:v1.25.3   "/usr/local/bin/entr…"   About a minute ago   Up About a minute                                                 kind-worker2
cb587ee92ef6   kindest/node:v1.25.3   "/usr/local/bin/entr…"   About a minute ago   Up About a minute                                                 kind-worker3
```
